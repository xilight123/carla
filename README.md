CARLA Simulator
===============

### Xight

- **安装Carla0.9.14版本**：0.9.10版本后的Laser才具有语义识别功能
  **安装UnrealEngine_4.24版本**
  详细安装步骤见链接：https://carla.readthedocs.io/en/latest/build_linux/

  注意：所有的依赖要安装链接中对应Ubuntu版本的依赖，否则编译会报错。

- 输入`make launch` 后会打开UnrealEngine界面（编辑模式），此状态下可以更改世界中的物体。初次运行会加载一些内置的东西，耐心等待即可

  但此时运行Python脚本时，会报如下超时错误：

  ```bash
  RuntimeError: time-out of 10000ms while waiting for the simulator, make sure the simulator is ready and connected to 127.0.0.1:2000
  RuntimeError: rpc::timeout: Timeout of 10000ms while connecting to 127.0.0.1:2000
  ```

  错误原因是没有点击play按钮时，Carla的server没有开始运行（端口为127.0.0.1/2000）

- **点击play按钮，让Carla运行在spectator视角模式，此时Python脚本可以正确运行！**
  
- 点击play按钮可能会遇到UnrealEngine闪退
  
  解决方案：
  
  1. 选择界面左上角的`Edit`，点击`Editor Preferences`，在`General`的`Performance`中将`Use Less CPU when in Backgroud`的对勾取消
  
  2. 若进行1操作后仍然闪退，则需更改Linux的swap空间大小
  
     ```
      # 查看swap空间大小
      $ free -m
      # 添加交换文件并设置其大小为8G，count=后面的数字表示要增加的swap空间的大小
      $ dd if=/dev/zero of=/tmp/swap bs=1MB count=8192
      # 使用命令mkswap创建swap空间
      $ mkswap /tmp/swap
      # 启动新增加的swap空间
      $ swapon /tmp/swap
      # 再次查看swap空间大小，确认是否添加成功
      $ free -m
      # 修改/etc/fstab文件，在文件最后加入下方文字：
      /tmp/swap swap swap defaults 0 0 
      # 系统重启后生效
     ```
  
     参考链接：https://blog.csdn.net/yabingshi_tech/article/details/77323617


- 添加一个FMCW激光雷达，需要更改的文件：

  ```cpp
  // 注册一个新的Sensor
  LibCarla/source/carla/sensor/SensorRegistry.h
  // FMCW Lidar数据结构XYZIRTVIdTag
  // Create a data object for the users of FMCW Lidar, representing the data of this.
  LibCarla/source/carla/sensor/data/FMCWLidarData.h
  // 一些测量的函数，在SensorData.cpp里用来获取一些Lidar的属性
  LibCarla/source/carla/sensor/data/FMCWLidarMeasurement.h
  // 新建序列化文件，数据的序列化
  // Object containing methods for serializing and deserializing the data generated by the FMCW Lidar. 
  LibCarla/source/carla/sensor/s11n/FMCWLidarSerializer.cpp
  LibCarla/source/carla/sensor/s11n/FMCWLidarSerializer.h
  // 将定义好的FMCW Lidar Data Struct注册到这里
  PythonAPI/carla/source/libcarla/SensorData.cpp
  // 将FMCW Lidar的属性（channels、range等）注册到ActorBlueprint里，以供函数调用
  Unreal/CarlaUE4/Plugins/Carla/Source/Carla/Actor/ActorBlueprintFunctionLibrary.cpp
  // Lidar的属性
  Unreal/CarlaUE4/Plugins/Carla/Source/Carla/Sensor/LidarDescription.h
  // FMCW Lidar的实现
  Unreal/CarlaUE4/Plugins/Carla/Source/Carla/Sensor/RayCastFMCWLidar.cpp
  Unreal/CarlaUE4/Plugins/Carla/Source/Carla/Sensor/RayCastFMCWLidar.h
  ```
  
  ```bash
  // 改完之后可能会报错GameInstance的错，在/carla/Unreal/CarlaUE4/Plugins/Carla/Source/Carla/Settings/CarlaSettingsDelegate.cpp中添加一下头文件即可
  #include "Carla/Game/CarlaGameInstance.h"
  ```
  
  ```bash
  carla-ros-bridge/src/ros-bridge/carla_ros_bridge/src/carla_ros_bridge/actor_factory.py
  carla-ros-bridge/src/ros-bridge/carla_ros_bridge/src/carla_ros_bridge/lidar.py
  /home/zk/catkin/carla-ros-bridge/src/xilight_car/xilight_car_spawn/config/objects.json
  ```


- 添加一个FMCW激光雷达用于DeepLearning，除了以上文件，还需要添加版本`carla-0.9.12`中路径下的`carla/Util/BuildTools/Setup.sh`文件，并添加：

  ```sh
  # Line 17
  USE_FMCWLidarDL=true
  
  # Line 474
  if ${USE_FMCWLidarDL} ; then
  
    # ==============================================================================
    # -- Get Eigen headers (Chrono dependency) for FMCW DeepLearning ---------------
    # ==============================================================================
  
    EIGEN_VERSION=3.3.7
    EIGEN_REPO=https://gitlab.com/libeigen/eigen/-/archive/3.3.7/eigen-3.3.7.tar.gz
    EIGEN_BASENAME=eigen-${EIGEN_VERSION}
  
    EIGEN_SRC_DIR=eigen-${EIGEN_VERSION}-src
    EIGEN_INSTALL_DIR=eigen-${EIGEN_VERSION}-install
    EIGEN_INCLUDE=${EIGEN_INSTALL_DIR}/include
  
  
    if [[ -d ${EIGEN_INSTALL_DIR} ]] ; then
      log "Eigen already installed."
    else
      log "Retrieving Eigen."
      wget ${EIGEN_REPO}
  
      log "Extracting Eigen."
      tar -xzf ${EIGEN_BASENAME}.tar.gz
      mv ${EIGEN_BASENAME} ${EIGEN_SRC_DIR}
      mkdir -p ${EIGEN_INCLUDE}/unsupported
      mv ${EIGEN_SRC_DIR}/Eigen ${EIGEN_INCLUDE}
      mv ${EIGEN_SRC_DIR}/unsupported/Eigen ${EIGEN_INCLUDE}/unsupported/Eigen
  
      rm -Rf ${EIGEN_BASENAME}.tar.gz
      rm -Rf ${EIGEN_SRC_DIR}
    fi
  
    mkdir -p ${LIBCARLA_INSTALL_SERVER_FOLDER}/include/
    cp -p -r ${EIGEN_INCLUDE}/* ${LIBCARLA_INSTALL_SERVER_FOLDER}/include/
  
  fi
  ```
  
  



#### 使用指南

官方文档：https://carla.readthedocs.io/en/latest/

FIRST STEP中，全部内容过一遍，主要注意力放在4th-Sensors and data

ADVANCED STEP中，基本都不用看，RSS未来有可能用到，mark一下

从Synchrony and time-step中可以知道，最适合我们的是同步+固定时间步长的模式

Traffic Manager内容较多，主要是用于让我们控制总体的交通情况，设置复杂的交通运行场景，现在没有马上就用到，可以晚些时候再看

Sensors reference里查看LIDAR sensor和Semantic LIDAR sensor

待看——carlaviz

#### 官方README

[![Build Status](https://travis-ci.org/carla-simulator/carla.svg?branch=master)](https://travis-ci.org/carla-simulator/carla)
[![Documentation](https://readthedocs.org/projects/carla/badge/?version=latest)](http://carla.readthedocs.io)

[![carla.org](Docs/img/btn/web.png)](http://carla.org)
[![download](Docs/img/btn/download.png)](https://github.com/carla-simulator/carla/blob/master/Docs/download.md)
[![documentation](Docs/img/btn/docs.png)](http://carla.readthedocs.io)
[![forum](Docs/img/btn/forum.png)](https://github.com/carla-simulator/carla/discussions)
[![discord](Docs/img/btn/chat.png)](https://discord.gg/8kqACuC)

CARLA is an open-source simulator for autonomous driving research. CARLA has been developed from the ground up to support development, training, and
validation of autonomous driving systems. In addition to open-source code and protocols, CARLA provides open digital assets (urban layouts, buildings,
vehicles) that were created for this purpose and can be used freely. The simulation platform supports flexible specification of sensor suites and
environmental conditions.

[![CARLA Video](Docs/img/video_thumbnail_0910.jpg)](https://www.youtube.com/watch?v=7jej46ALVRE)

If you want to benchmark your model in the same conditions as in our CoRL’17
paper, check out
[Benchmarking](https://github.com/carla-simulator/driving-benchmarks).

* [**Get CARLA overnight build**](http://carla-releases.s3.amazonaws.com/Linux/Dev/CARLA_Latest.tar.gz)

### Recommended system

* Intel i7 gen 9th - 11th / Intel i9 gen 9th - 11th / AMD ryzen 7 / AMD ryzen 9
* +16 GB RAM memory 
* NVIDIA RTX 2070 / NVIDIA RTX 2080 / NVIDIA RTX 3070, NVIDIA RTX 3080
* Ubuntu 18.04

## CARLA Ecosystem
Repositories associated to the CARLA simulation platform:

* [**CARLA Autonomous Driving leaderboard**](https://leaderboard.carla.org/): Automatic platform to validate Autonomous Driving stacks
* [**Scenario_Runner**](https://github.com/carla-simulator/scenario_runner): Engine to execute traffic scenarios in CARLA 0.9.X
* [**ROS-bridge**](https://github.com/carla-simulator/ros-bridge): Interface to connect CARLA 0.9.X to ROS
* [**Driving-benchmarks**](https://github.com/carla-simulator/driving-benchmarks): Benchmark tools for Autonomous Driving tasks
* [**Conditional Imitation-Learning**](https://github.com/felipecode/coiltraine): Training and testing Conditional Imitation Learning models in CARLA
* [**AutoWare AV stack**](https://github.com/carla-simulator/carla-autoware): Bridge to connect AutoWare AV stack to CARLA
* [**Reinforcement-Learning**](https://github.com/carla-simulator/reinforcement-learning): Code for running Conditional Reinforcement Learning models in CARLA
* [**Map Editor**](https://github.com/carla-simulator/carla-map-editor): Standalone GUI application to enhance RoadRunner maps with traffic lights and traffic signs information

**Like what you see? Star us on GitHub to support the project!**

Paper
-----

If you use CARLA, please cite our CoRL’17 paper.

_CARLA: An Open Urban Driving Simulator_<br>Alexey Dosovitskiy, German Ros,
Felipe Codevilla, Antonio Lopez, Vladlen Koltun; PMLR 78:1-16
[[PDF](http://proceedings.mlr.press/v78/dosovitskiy17a/dosovitskiy17a.pdf)]
[[talk](https://www.youtube.com/watch?v=xfyK03MEZ9Q&feature=youtu.be&t=2h44m30s)]


```
@inproceedings{Dosovitskiy17,
  title = {{CARLA}: {An} Open Urban Driving Simulator},
  author = {Alexey Dosovitskiy and German Ros and Felipe Codevilla and Antonio Lopez and Vladlen Koltun},
  booktitle = {Proceedings of the 1st Annual Conference on Robot Learning},
  pages = {1--16},
  year = {2017}
}
```

Building CARLA
--------------

Use `git clone` or download the project from this page. Note that the master branch contains the most recent release of CARLA with the latest fixes and features.

Then follow the instruction at [How to build on Linux][buildlinuxlink] or [How to build on Windows][buildwindowslink].  
The Linux build needs for an UE patch to solve some visualization issues regarding Vulkan. Those already working with a Linux build should install the patch and make the UE build again using the following commands.  
```sh
# Download and install the UE patch  
cd ~/UnrealEngine_4.24
wget https://carla-releases.s3.eu-west-3.amazonaws.com/Linux/UE_Patch/430667-13636743-patch.txt ~/430667-13636743-patch.txt
patch --strip=4 < ~/430667-13636743-patch.txt
# Build UE
./Setup.sh && ./GenerateProjectFiles.sh && make
```

Unfortunately we don't have official instructions to build on Mac yet, please check the progress at [issue #150][issue150].

[buildlinuxlink]: https://carla.readthedocs.io/en/latest/build_linux/
[buildwindowslink]: https://carla.readthedocs.io/en/latest/build_windows/
[issue150]: https://github.com/carla-simulator/carla/issues/150

Contributing
------------

Please take a look at our [Contribution guidelines][contriblink].

[contriblink]: https://carla.readthedocs.io/en/latest/cont_contribution_guidelines/

F.A.Q.
------

If you run into problems, check our
[FAQ](https://carla.readthedocs.io/en/latest/build_faq/).

CARLA Talks
------
The team creates some additional content for users, besides the docs. This is a great way to cover different subjects such as detailed explanations for a specific module, latest improvements in a feature, future work and much more.  

__CARLA Talks 2020 (May):__  

*   __General__  
	*   Art improvements: environment and rendering — [video](https://youtu.be/ZZaHevsz8W8) | [slides](https://drive.google.com/file/d/1l9Ztaq0Q8fNN5YPU4-5vL13eZUwsQl5P/view?usp=sharing)  
	*   Core implementations: synchrony, snapshots and landmarks — [video](https://youtu.be/nyyTLmphqY4) | [slides](https://drive.google.com/file/d/1yaOwf1419qWZqE1gTSrrknsWOhawEWh_/view?usp=sharing)
	*   Data ingestion — [video](https://youtu.be/mHiUUZ4xC9o) | [slides](https://drive.google.com/file/d/10uNBAMreKajYimIhwCqSYXjhfVs2bX31/view?usp=sharing)  
	*   Pedestrians and their implementation — [video](https://youtu.be/Uoz2ihDwaWA) | [slides](https://drive.google.com/file/d/1Tsosin7BLP1k558shtbzUdo2ZXVKy5CB/view?usp=sharing)  
	*   Sensors in CARLA — [video](https://youtu.be/T8qCSet8WK0) | [slides](https://drive.google.com/file/d/1UO8ZAIOp-1xaBzcFMfn_IoipycVkUo4q/view?usp=sharing)  
*   __Modules__  
	*   Improvements in the Traffic Manager — [video](https://youtu.be/n9cufaJ17eA) | [slides](https://drive.google.com/file/d/1R9uNZ6pYHSZoEBxs2vYK7swiriKbbuxo/view?usp=sharing)  
	*   Integration of autoware and ROS — [video](https://youtu.be/ChIgcC2scwU) | [slides](https://drive.google.com/file/d/1uO6nBaFirrllb08OeqGAMVLApQ6EbgAt/view?usp=sharing)  
	*   Introducing ScenarioRunner — [video](https://youtu.be/dcnnNJowqzM) | [slides](https://drive.google.com/file/d/1zgoH_kLOfIw117FJGm2IVZZAIRw9U2Q0/view?usp=sharing)  
	*   OpenSCENARIO support — [slides](https://drive.google.com/file/d/1g6ATxZRTWEdstiZwfBN1_T_x_WwZs0zE/view?usp=sharing)  
*   __Features__  
	*   Co-Simulations with SUMO and PTV-Vissim — [video](https://youtu.be/PuFSbj1PU94) | [slides](https://drive.google.com/file/d/10DgMNUBqKqWBrdiwBiAIT4DdR9ObCquI/view?usp=sharing)  
	*   Integration of RSS-lib — [slides](https://drive.google.com/file/d/1whREmrCv67fOMipgCk6kkiW4VPODig0A/view?usp=sharing)  
	*   The External Sensor Interface (ESI) — [video](https://youtu.be/5hXHPV9FIeY) | [slides](https://drive.google.com/file/d/1VWFaEoS12siW6NtQDUkm44BVO7tveRbJ/view?usp=sharing)  
	*   The OpenDRIVE Standalone Mode — [video](https://youtu.be/U25GhofVV1Q) | [slides](https://drive.google.com/file/d/1D5VsgfX7dmgPWn7UtDDid3-OdS1HI4pY/view?usp=sharing)  

Licenses
-------

#### CARLA licenses

CARLA specific code is distributed under MIT License.

CARLA specific assets are distributed under CC-BY License.

#### CARLA Dependency and Integration licenses

The ad-rss-lib library compiled and linked by the [RSS Integration build variant](Docs/adv_rss.md) introduces [LGPL-2.1-only License](https://opensource.org/licenses/LGPL-2.1).

Unreal Engine 4 follows its [own license terms](https://www.unrealengine.com/en-US/faq).

CARLA uses three dependencies as part of the SUMO integration:
- [PROJ](https://proj.org/), a generic coordinate transformation software which uses the [X/MIT open source license](https://proj.org/about.html#license).
- [SQLite](https://www.sqlite.org), part of the PROJ dependencies, which is [in the public domain](https://www.sqlite.org/purchase/license).
- [Xerces-C](https://xerces.apache.org/xerces-c/), a validating XML parser, which is made available under the [Apache Software License, Version 2.0](http://www.apache.org/licenses/LICENSE-2.0.html).

CARLA uses one dependency as part of the Chrono integration:
- [Eigen](https://eigen.tuxfamily.org/index.php?title=Main_Page), a C++ template library for linear algebra which uses the [MPL2 license](https://www.mozilla.org/en-US/MPL/2.0/).

CARLA uses the Autodesk FBX SDK for converting FBX to OBJ in the import process of maps. This step is optional, and the SDK is located [here](https://www.autodesk.com/developer-network/platform-technologies/fbx-sdk-2020-0)

This software contains Autodesk® FBX® code developed by Autodesk, Inc. Copyright 2020 Autodesk, Inc. All rights, reserved. Such code is provided "as is" and Autodesk, Inc. disclaims any and all warranties, whether express or implied, including without limitation the implied warranties of merchantability, fitness for a particular purpose or non-infringement of third party rights. In no event shall Autodesk, Inc. be liable for any direct, indirect, incidental, special, exemplary, or consequential damages (including, but not limited to, procurement of substitute goods or services; loss of use, data, or profits; or business interruption) however caused and on any theory of liability, whether in contract, strict liability, or tort (including negligence or otherwise) arising in any way out of such code."
